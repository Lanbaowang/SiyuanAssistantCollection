/* esm.sh - esbuild bundle(graphql-http@1.22.0/lib/use/koa) es2022 production */
import{validate as K,specifiedRules as C,execute as W,parse as z,getOperationAST as D,GraphQLError as N}from"./graphql.js";
function P(e){return typeof e=="object"&&e!==null}function k(e){return P(e)&&("data"in e||"data"in e&&e.data==null&&"errors"in e)}function U(e){return typeof Object(e)[Symbol.asyncIterator]=="function"}function g(e){return Array.isArray(e)&&(typeof e[0]=="string"||e[0]===null)&&P(e[1])}async function x(e){var n,a;let t=e.method;if(t!=="GET"&&t!=="POST")return[null,{status:405,statusText:"Method Not Allowed",headers:{allow:"GET, POST"}}];let[i,l="charset=utf-8"]=(_(e,"content-type")||"").replace(/\s/g,"").toLowerCase().split(";"),r={};switch(!0){case t==="GET":{try{let[,o]=e.url.split("?"),c=new URLSearchParams(o);r.operationName=(n=c.get("operationName"))!==null&&n!==void 0?n:void 0,r.query=(a=c.get("query"))!==null&&a!==void 0?a:void 0;let b=c.get("variables");b&&(r.variables=JSON.parse(b));let m=c.get("extensions");m&&(r.extensions=JSON.parse(m))}catch{throw new Error("Unparsable URL")}break}case(t==="POST"&&i==="application/json"&&l==="charset=utf-8"):{if(!e.body)throw new Error("Missing body");let o;try{let c=typeof e.body=="function"?await e.body():e.body;o=typeof c=="string"?JSON.parse(c):c}catch{throw new Error("Unparsable JSON body")}if(!P(o))throw new Error("JSON body must be an object");r.operationName=o.operationName,r.query=o.query,r.variables=o.variables,r.extensions=o.extensions;break}default:return[null,{status:415,statusText:"Unsupported Media Type"}]}if(r.query==null)throw new Error("Missing query");if(typeof r.query!="string")throw new Error("Invalid query");if(r.variables!=null&&(typeof r.variables!="object"||Array.isArray(r.variables)))throw new Error("Invalid variables");if(r.operationName!=null&&typeof r.operationName!="string")throw new Error("Invalid operationName");if(r.extensions!=null&&(typeof r.extensions!="object"||Array.isArray(r.extensions)))throw new Error("Invalid extensions");return r}function H(e){let{schema:n,context:a,validate:t=K,validationRules:i=[],execute:l=W,parse:r=z,getOperationAST:o=D,rootValue:c,onSubscribe:b,onOperation:m,formatError:d=I=>I,parseRequestParams:Q=x}=e;return async function(f){let p=null,B=(_(f,"accept")||"*/*").replace(/\s/g,"").toLowerCase().split(",");for(let s of B){let[w,...O]=s.split(";"),T=O?.find(R=>R.includes("charset="))||"charset=utf8";if(w==="application/graphql-response+json"&&T==="charset=utf8"){p="application/graphql-response+json";break}if((w==="application/json"||w==="application/*"||w==="*/*")&&T==="charset=utf8"){p="application/json";break}}if(!p)return[null,{status:406,statusText:"Not Acceptable",headers:{accept:"application/graphql-response+json; charset=utf-8, application/json; charset=utf-8"}}];let j;try{let s=await Q(f);if(s||(s=await x(f)),g(s))return s;j=s}catch(s){return h(s,p,d)}let u,y=await b?.(f,j);if(g(y))return y;if(k(y)||M(y))return h(y,p,d);if(y)u=y;else{if(!n)throw new Error("The GraphQL schema is not provided");let{operationName:s,query:w,variables:O}=j,T;try{T=r(w)}catch(S){return h(S,p,d)}let R=typeof a=="function"?await a(f,j):a;if(g(R))return R;let J={operationName:s,document:T,variableValues:O,contextValue:R};if(typeof n=="function"){let S=await n(f,J);if(g(S))return S;u=Object.assign(Object.assign({},J),{schema:S})}else u=Object.assign(Object.assign({},J),{schema:n});let v=C;typeof i=="function"?v=await i(f,u,C):v=[...v,...i];let V=t(u.schema,u.document,v);if(V.length)return h(V,p,d)}let G;try{let s=o(u.document,u.operationName);if(!s)throw null;G=s.operation}catch{return h(new N("Unable to detect operation AST"),p,d)}if(G==="subscription")return h(new N("Subscriptions are not supported"),p,d);if(G==="mutation"&&f.method==="GET")return[JSON.stringify({errors:[new N("Cannot perform mutations over GET")]}),{status:405,statusText:"Method Not Allowed",headers:{allow:"POST"}}];if("rootValue"in u||(u.rootValue=c),!("contextValue"in u)){let s=typeof a=="function"?await a(f,j):a;if(g(s))return s;u.contextValue=s}let q=await l(u),A=await m?.(f,u,q);return g(A)?A:(A&&(q=A),U(q)?h(new N("Subscriptions are not supported"),p,d):h(q,p,d))}}function h(e,n,a){if(e instanceof Error&&!E(e))return[JSON.stringify({errors:[a(e)]},L),{status:400,statusText:"Bad Request",headers:{"content-type":"application/json; charset=utf-8"}}];let t=E(e)?[e]:M(e)?e:null;return t?[JSON.stringify({errors:t.map(a)},L),Object.assign(Object.assign({},n==="application/json"?{status:200,statusText:"OK"}:{status:400,statusText:"Bad Request"}),{headers:{"content-type":n==="application/json"?"application/json; charset=utf-8":"application/graphql-response+json; charset=utf-8"}})]:[JSON.stringify("errors"in e&&e.errors?Object.assign(Object.assign({},e),{errors:e.errors.map(a)}):e,L),{status:200,statusText:"OK",headers:{"content-type":n==="application/json"?"application/json; charset=utf-8":"application/graphql-response+json; charset=utf-8"}}]}function _(e,n){return typeof e.headers.get=="function"?e.headers.get(n):Object(e.headers)[n]}function M(e){return Array.isArray(e)&&e.length>0&&e.some(E)}function E(e){return e instanceof N}function L(e,n){return n instanceof Error&&!E(n)?{message:n.message}:n}async function te(e){let n=F(e),a=await x(n);if(!("query"in a)){let[t,i]=a;if(e.body=t,e.response.status=i.status,e.response.message=i.statusText,i.headers)for(let[l,r]of Object.entries(i.headers))e.response.set(l,r);return null}return a}function re(e){let n=H(e);return async function(t){try{let[i,l]=await n({url:t.url,method:t.method,headers:t.headers,body:()=>t.body?t.body:new Promise(r=>{let o="";t.req.on("data",c=>o+=c),t.req.on("end",()=>r(o))}),raw:t.req,context:{res:t.response}});if(t.body=i,t.response.status=l.status,t.response.message=l.statusText,l.headers)for(let[r,o]of Object.entries(l.headers))t.response.set(r,o)}catch(i){console.error("Internal error occurred during request handling. Please check your implementation.",i),t.response.status=500}}}function F(e){return{url:e.url,method:e.method,headers:e.headers,body:()=>e.body?e.body:new Promise(n=>{let a="";e.req.on("data",t=>a+=t),e.req.on("end",()=>n(a))}),raw:e.req,context:{res:e.response}}}export{re as createHandler,te as parseRequestParams};
//# sourceMappingURL=koa.bundle.js.map