/* esm.sh - esbuild bundle(stream-http@3.2.0) es2022 production */
import __Process$ from "./node_process.js";
import { Buffer as __Buffer$ } from "./buffer.js";
var __global$ = globalThis || (typeof window !== "undefined" ? window : self);
import * as __0$ from "./xtend.js";
import * as __1$ from "./builtin-status-codes.js";
import * as __2$ from "./url.js";
import * as __3$ from "./inherits.js";
import * as __4$ from "./readable-stream.js";
import * as __5$ from "./inherits.js";
import * as __6$ from "./readable-stream.js";
var require=n=>{const e=m=>typeof m.default<"u"?m.default:m,c=m=>Object.assign({},m);switch(n){case"xtend":return e(__0$);case"builtin-status-codes":return e(__1$);case"url":return e(__2$);case"inherits":return e(__3$);case"readable-stream":return e(__4$);default:throw new Error("module \""+n+"\" not found");}};
var V=Object.create;var S=Object.defineProperty;var j=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var $=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var v=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(r,o)=>(typeof require<"u"?require:r)[o]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var E=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports),Q=(e,r)=>{for(var o in r)S(e,o,{get:r[o],enumerable:!0})},R=(e,r,o,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of Y(r))!J.call(e,t)&&t!==o&&S(e,t,{get:()=>r[t],enumerable:!(s=j(r,t))||s.enumerable});return e},y=(e,r,o)=>(R(e,r,"default"),o&&R(o,r,"default")),P=(e,r,o)=>(o=e!=null?V($(e)):{},R(r||!e||!e.__esModule?S(o,"default",{value:e,enumerable:!0}):o,e));var H=E(l=>{l.fetch=T(__global$.fetch)&&T(__global$.ReadableStream);l.writableStream=T(__global$.WritableStream);l.abortController=T(__global$.AbortController);var m;function w(){if(m!==void 0)return m;if(__global$.XMLHttpRequest){m=new __global$.XMLHttpRequest;try{m.open("GET",__global$.XDomainRequest?"/":"https://example.com")}catch{m=null}}else m=null;return m}function q(e){var r=w();if(!r)return!1;try{return r.responseType=e,r.responseType===e}catch{}return!1}l.arraybuffer=l.fetch||q("arraybuffer");l.msstream=!l.fetch&&q("ms-stream");l.mozchunkedarraybuffer=!l.fetch&&q("moz-chunked-arraybuffer");l.overrideMimeType=l.fetch||(w()?T(w().overrideMimeType):!1);function T(e){return typeof e=="function"}m=null});var k=E(M=>{var N=H(),Z=v("inherits"),D=v("readable-stream"),A=M.readyStates={UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4},O=M.IncomingMessage=function(e,r,o,s){var t=this;if(D.Readable.call(t),t._mode=o,t.headers={},t.rawHeaders=[],t.trailers={},t.rawTrailers=[],t.on("end",function(){__Process$.nextTick(function(){t.emit("close")})}),o==="fetch"){let _=function(){c.read().then(function(a){if(!t._destroyed){if(s(a.done),a.done){t.push(null);return}t.push(__Buffer$.from(a.value)),_()}}).catch(function(a){s(!0),t._destroyed||t.emit("error",a)})};var C=_;if(t._fetchResponse=r,t.url=r.url,t.statusCode=r.status,t.statusMessage=r.statusText,r.headers.forEach(function(a,f){t.headers[f.toLowerCase()]=a,t.rawHeaders.push(f,a)}),N.writableStream){var h=new WritableStream({write:function(a){return s(!1),new Promise(function(f,W){t._destroyed?W():t.push(__Buffer$.from(a))?f():t._resumeFetch=f})},close:function(){s(!0),t._destroyed||t.push(null)},abort:function(a){s(!0),t._destroyed||t.emit("error",a)}});try{r.body.pipeTo(h).catch(function(a){s(!0),t._destroyed||t.emit("error",a)});return}catch{}}var c=r.body.getReader();_()}else{t._xhr=e,t._pos=0,t.url=e.responseURL,t.statusCode=e.status,t.statusMessage=e.statusText;var n=e.getAllResponseHeaders().split(/\r?\n/);if(n.forEach(function(_){var a=_.match(/^([^:]+):\s*(.*)/);if(a){var f=a[1].toLowerCase();f==="set-cookie"?(t.headers[f]===void 0&&(t.headers[f]=[]),t.headers[f].push(a[2])):t.headers[f]!==void 0?t.headers[f]+=", "+a[2]:t.headers[f]=a[2],t.rawHeaders.push(a[1],a[2])}}),t._charset="x-user-defined",!N.overrideMimeType){var i=t.rawHeaders["mime-type"];if(i){var g=i.match(/;\s*charset=([^;])(;|$)/);g&&(t._charset=g[1].toLowerCase())}t._charset||(t._charset="utf-8")}}};Z(O,D.Readable);O.prototype._read=function(){var e=this,r=e._resumeFetch;r&&(e._resumeFetch=null,r())};O.prototype._onXHRProgress=function(e){var r=this,o=r._xhr,s=null;switch(r._mode){case"text":if(s=o.responseText,s.length>r._pos){var t=s.substr(r._pos);if(r._charset==="x-user-defined"){for(var h=__Buffer$.alloc(t.length),c=0;c<t.length;c++)h[c]=t.charCodeAt(c)&255;r.push(h)}else r.push(t,r._charset);r._pos=s.length}break;case"arraybuffer":if(o.readyState!==A.DONE||!o.response)break;s=o.response,r.push(__Buffer$.from(new Uint8Array(s)));break;case"moz-chunked-arraybuffer":if(s=o.response,o.readyState!==A.LOADING||!s)break;r.push(__Buffer$.from(new Uint8Array(s)));break;case"ms-stream":if(s=o.response,o.readyState!==A.LOADING)break;var n=new __global$.MSStreamReader;n.onprogress=function(){n.result.byteLength>r._pos&&(r.push(__Buffer$.from(new Uint8Array(n.result.slice(r._pos)))),r._pos=n.result.byteLength)},n.onload=function(){e(!0),r.push(null)},n.readAsArrayBuffer(s);break}r._xhr.readyState===A.DONE&&r._mode!=="ms-stream"&&(e(!0),r.push(null))}});var X=E((Ce,U)=>{var b=H(),ee=v("inherits"),B=k(),L=v("readable-stream"),re=B.IncomingMessage,x=B.readyStates;function te(e,r){return b.fetch&&r?"fetch":b.mozchunkedarraybuffer?"moz-chunked-arraybuffer":b.msstream?"ms-stream":b.arraybuffer&&e?"arraybuffer":"text"}var u=U.exports=function(e){var r=this;L.Writable.call(r),r._opts=e,r._body=[],r._headers={},e.auth&&r.setHeader("Authorization","Basic "+__Buffer$.from(e.auth).toString("base64")),Object.keys(e.headers).forEach(function(t){r.setHeader(t,e.headers[t])});var o,s=!0;if(e.mode==="disable-fetch"||"requestTimeout"in e&&!b.abortController)s=!1,o=!0;else if(e.mode==="prefer-streaming")o=!1;else if(e.mode==="allow-wrong-content-type")o=!b.overrideMimeType;else if(!e.mode||e.mode==="default"||e.mode==="prefer-fast")o=!0;else throw new Error("Invalid value for opts.mode");r._mode=te(o,s),r._fetchTimer=null,r._socketTimeout=null,r._socketTimer=null,r.on("finish",function(){r._onFinish()})};ee(u,L.Writable);u.prototype.setHeader=function(e,r){var o=this,s=e.toLowerCase();se.indexOf(s)===-1&&(o._headers[s]={name:e,value:r})};u.prototype.getHeader=function(e){var r=this._headers[e.toLowerCase()];return r?r.value:null};u.prototype.removeHeader=function(e){var r=this;delete r._headers[e.toLowerCase()]};u.prototype._onFinish=function(){var e=this;if(!e._destroyed){var r=e._opts;"timeout"in r&&r.timeout!==0&&e.setTimeout(r.timeout);var o=e._headers,s=null;r.method!=="GET"&&r.method!=="HEAD"&&(s=new Blob(e._body,{type:(o["content-type"]||{}).value||""}));var t=[];if(Object.keys(o).forEach(function(i){var g=o[i].name,C=o[i].value;Array.isArray(C)?C.forEach(function(_){t.push([g,_])}):t.push([g,C])}),e._mode==="fetch"){var h=null;if(b.abortController){var c=new AbortController;h=c.signal,e._fetchAbortController=c,"requestTimeout"in r&&r.requestTimeout!==0&&(e._fetchTimer=__global$.setTimeout(function(){e.emit("requestTimeout"),e._fetchAbortController&&e._fetchAbortController.abort()},r.requestTimeout))}__global$.fetch(e._opts.url,{method:e._opts.method,headers:t,body:s||void 0,mode:"cors",credentials:r.withCredentials?"include":"same-origin",signal:h}).then(function(i){e._fetchResponse=i,e._resetTimers(!1),e._connect()},function(i){e._resetTimers(!0),e._destroyed||e.emit("error",i)})}else{var n=e._xhr=new __global$.XMLHttpRequest;try{n.open(e._opts.method,e._opts.url,!0)}catch(i){__Process$.nextTick(function(){e.emit("error",i)});return}"responseType"in n&&(n.responseType=e._mode),"withCredentials"in n&&(n.withCredentials=!!r.withCredentials),e._mode==="text"&&"overrideMimeType"in n&&n.overrideMimeType("text/plain; charset=x-user-defined"),"requestTimeout"in r&&(n.timeout=r.requestTimeout,n.ontimeout=function(){e.emit("requestTimeout")}),t.forEach(function(i){n.setRequestHeader(i[0],i[1])}),e._response=null,n.onreadystatechange=function(){switch(n.readyState){case x.LOADING:case x.DONE:e._onXHRProgress();break}},e._mode==="moz-chunked-arraybuffer"&&(n.onprogress=function(){e._onXHRProgress()}),n.onerror=function(){e._destroyed||(e._resetTimers(!0),e.emit("error",new Error("XHR error")))};try{n.send(s)}catch(i){__Process$.nextTick(function(){e.emit("error",i)});return}}}};function oe(e){try{var r=e.status;return r!==null&&r!==0}catch{return!1}}u.prototype._onXHRProgress=function(){var e=this;e._resetTimers(!1),!(!oe(e._xhr)||e._destroyed)&&(e._response||e._connect(),e._response._onXHRProgress(e._resetTimers.bind(e)))};u.prototype._connect=function(){var e=this;e._destroyed||(e._response=new re(e._xhr,e._fetchResponse,e._mode,e._resetTimers.bind(e)),e._response.on("error",function(r){e.emit("error",r)}),e.emit("response",e._response))};u.prototype._write=function(e,r,o){var s=this;s._body.push(e),o()};u.prototype._resetTimers=function(e){var r=this;__global$.clearTimeout(r._socketTimer),r._socketTimer=null,e?(__global$.clearTimeout(r._fetchTimer),r._fetchTimer=null):r._socketTimeout&&(r._socketTimer=__global$.setTimeout(function(){r.emit("timeout")},r._socketTimeout))};u.prototype.abort=u.prototype.destroy=function(e){var r=this;r._destroyed=!0,r._resetTimers(!0),r._response&&(r._response._destroyed=!0),r._xhr?r._xhr.abort():r._fetchAbortController&&r._fetchAbortController.abort(),e&&r.emit("error",e)};u.prototype.end=function(e,r,o){var s=this;typeof e=="function"&&(o=e,e=void 0),L.Writable.prototype.end.call(s,e,r,o)};u.prototype.setTimeout=function(e,r){var o=this;r&&o.once("timeout",r),o._socketTimeout=e,o._resetTimers(!1)};u.prototype.flushHeaders=function(){};u.prototype.setNoDelay=function(){};u.prototype.setSocketKeepAlive=function(){};var se=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","date","dnt","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"]});var I=E(F=>{var G=X(),ne=k(),ae=v("xtend"),ie=v("builtin-status-codes"),ue=v("url"),d=F;d.request=function(e,r){typeof e=="string"?e=ue.parse(e):e=ae(e);var o=__global$.location.protocol.search(/^https?:$/)===-1?"http:":"",s=e.protocol||o,t=e.hostname||e.host,h=e.port,c=e.path||"/";t&&t.indexOf(":")!==-1&&(t="["+t+"]"),e.url=(t?s+"//"+t:"")+(h?":"+h:"")+c,e.method=(e.method||"GET").toUpperCase(),e.headers=e.headers||{};var n=new G(e);return r&&n.on("response",r),n};d.get=function(r,o){var s=d.request(r,o);return s.end(),s};d.ClientRequest=G;d.IncomingMessage=ne.IncomingMessage;d.Agent=function(){};d.Agent.defaultMaxSockets=4;d.globalAgent=new d.Agent;d.STATUS_CODES=ie;d.METHODS=["CHECKOUT","CONNECT","COPY","DELETE","GET","HEAD","LOCK","M-SEARCH","MERGE","MKACTIVITY","MKCOL","MOVE","NOTIFY","OPTIONS","PATCH","POST","PROPFIND","PROPPATCH","PURGE","PUT","REPORT","SEARCH","SUBSCRIBE","TRACE","UNLOCK","UNSUBSCRIBE"]});var p={};Q(p,{Agent:()=>he,ClientRequest:()=>ce,IncomingMessage:()=>de,METHODS:()=>_e,STATUS_CODES:()=>pe,default:()=>ye,get:()=>le,globalAgent:()=>me,request:()=>fe});var K=P(I());y(p,P(I()));var{request:fe,get:le,ClientRequest:ce,IncomingMessage:de,Agent:he,globalAgent:me,STATUS_CODES:pe,METHODS:_e}=K,{default:z,...ve}=K,ye=z!==void 0?z:ve;export{he as Agent,ce as ClientRequest,de as IncomingMessage,_e as METHODS,pe as STATUS_CODES,ye as default,le as get,me as globalAgent,fe as request};
//# sourceMappingURL=stream-http.mjs.map